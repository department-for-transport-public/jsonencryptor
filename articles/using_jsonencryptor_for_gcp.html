<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>using_jsonencryptor_for_gcp • jsonencryptor</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="using_jsonencryptor_for_gcp">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">jsonencryptor</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/using_jsonencryptor_for_gcp.html">using_jsonencryptor_for_gcp</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>using_jsonencryptor_for_gcp</h1>
            
      

      <div class="d-none name"><code>using_jsonencryptor_for_gcp.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://department-for-transport-public.github.io/jsonencryptor/">jsonencryptor</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: sodium</span></span>
<span><span class="co">#&gt; Loading required package: fs</span></span></code></pre></div>
<div class="section level2">
<h2 id="using-service-accounts-for-r-gcp-connectivity">Using service accounts for R-GCP connectivity<a class="anchor" aria-label="anchor" href="#using-service-accounts-for-r-gcp-connectivity"></a>
</h2>
<p>Service accounts are an alternative to personal authentication tokens
for connecting to Google Cloud Platform (GCP) services. Rather than
running on your own user account, service accounts are created by the
GCP administrator and are used to authenticate the R session. This is
useful for running R scripts when you don’t want to authenticate
interactively; either because you’re running something like Rmarkdown or
Shiny, or simply because it’s annoying to do it every hour!</p>
</div>
<div class="section level2">
<h2 id="creating-a-service-account">Creating a service account<a class="anchor" aria-label="anchor" href="#creating-a-service-account"></a>
</h2>
<p>You can download your service account key from GCP in JSON format.
This unencrypted key can be used to authenticate your R session.
However, it’s not a good idea to store this key in plain text, as it
could be easily stolen. Instead, you can use the
<code>jsonencryptor</code> package to encrypt the key so that it can
only be unencrypted with the password you set for it.</p>
</div>
<div class="section level2">
<h2 id="creating-and-storing-a-password">Creating and storing a password<a class="anchor" aria-label="anchor" href="#creating-and-storing-a-password"></a>
</h2>
<p>First, you need to install the <code>jsonencryptor</code> package
from Github:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"department-for-transport-public/jsonencryptor"</span><span class="op">)</span>   </span></code></pre></div>
<p>As the first step, you should set up a password for your service
account key. This password will be used to encrypt and decrypt the key.
You can create the password using the <code><a href="../reference/secret_pw_gen.html">secret_pw_gen()</a></code>
function, which produces a random, hard-to-guess password of a specified
length:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/secret_pw_gen.html">secret_pw_gen</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This password is secret and should <em>never</em> be stored in your
code. Instead, you can save it in the .Renviron file in your home
directory. This file is used to store environment variables that are
loaded when R starts, and are not available to accidentally push to
Github, or for anyone else to access. You can add a line like this to
your .Renviron file:</p>
<pre><code><span><span class="va">GARGLE_PASSWORD</span> <span class="op">=</span> <span class="st">"your_password_here"</span></span></code></pre>
<p>Make sure you include an extra line at the end of the file to ensure
that the last line is read by R, and then restart R.</p>
<p>You can check your password is accessible in your R session using the
<code><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv()</a></code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GARGLE_PASSWORD"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="encrypting-your-service-account-key">Encrypting your service account key<a class="anchor" aria-label="anchor" href="#encrypting-your-service-account-key"></a>
</h2>
<p>Once you have your password set up, you can use the
<code><a href="../reference/secret_write.html">secret_write()</a></code> function to encrypt your service account
key. This function takes the path to your service account key and the
name you’d like to call your encrypted key as arguments.</p>
<p>For example, if your service account key is called
“service_account_key.json”, you can encrypt it using the following
code:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/secret_write.html">secret_write</a></span><span class="op">(</span><span class="st">"service_account_key.json"</span>, <span class="st">"encryped_key.json"</span><span class="op">)</span></span></code></pre></div>
<p>This will create a new file called “encrypted_key.json”, which is
stored inside a <code>inst/secret</code> directory. This file is
encrypted and can only be decrypted using the password you set up
earlier. At this point, you should ensure you <em>delete</em> your
original service account key, as it is no longer needed and represents a
security risk if accidentally shared</p>
</div>
<div class="section level2">
<h2 id="using-your-encrypted-key">Using your encrypted key<a class="anchor" aria-label="anchor" href="#using-your-encrypted-key"></a>
</h2>
<p>To use your encrypted key, you can use the <code><a href="../reference/secret_read.html">secret_read()</a></code>
function. This function takes the name of your encrypted key as an
argument, and returns the contents of the decrypted key ready to use to
authenticate your R session.</p>
<p>For example, you can use the following code to read your encrypted
key:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/secret_read.html">secret_read</a></span><span class="op">(</span><span class="st">"encrypted_key.json"</span><span class="op">)</span></span></code></pre></div>
<p>There’s no need to specify that the encrypted key is stored inside
the <code>inst/secret</code> directory, as the
<code><a href="../reference/secret_read.html">secret_read()</a></code> function knows where to look.</p>
</div>
<div class="section level2">
<h2 id="using-your-key-to-access-gcp-services">Using your key to access GCP services<a class="anchor" aria-label="anchor" href="#using-your-key-to-access-gcp-services"></a>
</h2>
<div class="section level3">
<h3 id="bigquery">BigQuery<a class="anchor" aria-label="anchor" href="#bigquery"></a>
</h3>
<p>When using this encrypted key, the easiest and most secure way to do
this is to pass the key directly to the
<code>gargle::gargle_oauth()</code> function, which is used to
authenticate your R session with GCP services. For example, you can use
the following code to authenticate your R session with the
<code>bigrquery</code> package:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bigrquery.r-dbi.org" class="external-link">bigrquery</a></span><span class="op">)</span></span>
<span><span class="fu">bq_auth</span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="../reference/secret_read.html">secret_read</a></span><span class="op">(</span><span class="st">"encrypted_key.json"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This will authenticate your session, no error message means that it
has completed successfully. You can now use the <code>bigrquery</code>
package to query your GCP data. For example:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span></span>
<span>  <span class="fu">bigrquery</span><span class="fu">::</span><span class="fu">bigquery</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  project <span class="op">=</span> <span class="st">"your_project_id"</span>,</span>
<span>  dataset <span class="op">=</span> <span class="st">"your_dataset"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="google-cloud-storage">Google cloud storage<a class="anchor" aria-label="anchor" href="#google-cloud-storage"></a>
</h3>
<p>You can also use your encrypted key to access Google Cloud Storage.
For example, you can use the <code>gcs_auth()</code> function from the
<code>googleCloudStorageR</code> package to authenticate your R
session:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudStorageR/" class="external-link">googleCloudStorageR</a></span><span class="op">)</span></span>
<span><span class="fu">gcs_auth</span><span class="op">(</span>token <span class="op">=</span> <span class="fu"><a href="../reference/secret_read.html">secret_read</a></span><span class="op">(</span><span class="st">"encrypted_key.json"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This will authenticate your session, no error message means that it
has completed successfully. You can now use the
<code>googleCloudStorageR</code> package to access your GCP storage. For
example:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gcs_list_buckets</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="error-handling">Error handling<a class="anchor" aria-label="anchor" href="#error-handling"></a>
</h2>
<p>If you get an error message when trying to authenticate your session,
it’s likely that the key is failing to decrypt. This could be because
the password is incorrect, or because you are providing the wrong path
location to the function. In either case, you will get a similar error
that will look like this:</p>
<pre><code>Access Denied: Dataset your-project-name:your-dataset: Permission bigquery.tables.list denied
  on dataset your-project-name:your-dataset (or it may not exist)</code></pre>
<p>Despite what the error says, this is rarely caused by missing
permissions on your service account. Check that your service key exists
in the <code>inst/secret</code> directory, and that the password is
correct. If you’re still having trouble, you can try re-encrypting the
key using the <code><a href="../reference/secret_write.html">secret_write()</a></code> function, and then
re-authenticating your session.</p>
<p>For any other permissions errors, it is likely that your service
account is missing the specified permissions. You can check this by
going to the GCP console, and checking the permissions for your service
account.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Francesca Bryden.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
